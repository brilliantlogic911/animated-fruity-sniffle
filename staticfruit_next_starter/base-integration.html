<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>StaticFruit Base Integration</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      
      .container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      h1 {
        color: #2a2a2a;
        text-align: center;
      }
      
      .button {
        background-color: #0052ff;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 6px;
        cursor: pointer;
        margin: 10px;
        transition: background-color 0.3s;
      }
      
      .button:hover {
        background-color: #0040d9;
      }
      
      .button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      
      #status {
        margin-top: 20px;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        font-weight: bold;
      }
      
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      
      .user-info {
        margin-top: 20px;
        padding: 15px;
        background-color: #e9ecef;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>StaticFruit Base Integration</h1>
      
      <div style="text-align: center;">
        <button id="signin" class="button">Sign in with Base</button>
        <button id="pay" class="button" disabled>Pay with Base</button>
      </div>
      
      <div id="status" class="info">Ready to connect...</div>
      
      <div id="userInfo" class="user-info" style="display: none;">
        <h3>Connected User:</h3>
        <p>Address: <span id="userAddress"></span></p>
      </div>

      <!-- Load Base Account SDK via CDN -->
      <script src="https://unpkg.com/@base-org/account/dist/base-account.min.js"></script>
      
      <script>
        // Initialize Base Account SDK with app configuration
        const provider = window.createBaseAccountSDK({
          appName: 'StaticFruit',
          appLogoUrl: 'https://base.org/logo.png', // You might want to use your own logo
        }).getProvider();
        
        const statusDiv = document.getElementById("status");
        const userInfoDiv = document.getElementById("userInfo");
        const userAddressSpan = document.getElementById("userAddress");
        const payButton = document.getElementById("pay");
        let userAddress = null;

        function showStatus(message, type = 'info') {
          statusDiv.innerHTML = message;
          statusDiv.className = type;
        }

        // Generate a fresh nonce for authentication
        function generateNonce() {
          return window.crypto.randomUUID().replace(/-/g, '');
        }

        // Sign in with Base using wallet_connect method
        document.getElementById("signin").onclick = async () => {
          try {
            showStatus("Connecting to Base Account...", 'info');
            
            // Generate a fresh nonce
            const nonce = generateNonce();
            
            // Connect and authenticate using the new wallet_connect method
            const { accounts } = await provider.request({
              method: 'wallet_connect',
              params: [{
                version: '1',
                capabilities: {
                  signInWithEthereum: { 
                    nonce, 
                    chainId: '0x2105' // Base Mainnet - 8453
                  }
                }
              }]
            });
            
            const { address } = accounts[0];
            const { message, signature } = accounts[0].capabilities.signInWithEthereum;
            
            userAddress = address;
            userAddressSpan.textContent = address;
            userInfoDiv.style.display = 'block';
            payButton.disabled = false;
            
            showStatus(`‚úÖ Successfully signed in! Address: ${address.slice(0, 6)}...${address.slice(-4)}`, 'success');
            
            // In a real app, you would send the message and signature to your backend for verification
            console.log('Authentication data:', { address, message, signature });
            
          } catch (error) {
            console.error('Sign-in error:', error);
            showStatus(`‚ùå Sign-in failed: ${error.message}`, 'error');
          }
        };

        // One-tap USDC payment using window.base API (works with or without sign-in)
        document.getElementById("pay").onclick = async () => {
          try {
            showStatus("Processing payment...", 'info');
            
            // For StaticFruit, we might want to customize this payment
            // For example, paying for minting a StaticSeed NFT or purchasing a JuicePress item
            const result = await window.base.pay({
              amount: "5.00", // USD ‚Äì SDK quotes equivalent USDC
              to: "0xF6167EEC6C79849BcFb6a952d16c5509af5209e7", // StaticSeeds contract address
              testnet: false // Set to false for Mainnet
            });

            const status = await window.base.getPaymentStatus({
              id: result.id,
              testnet: false
            });
            
            showStatus(`üéâ Payment completed! Status: ${status.status}`, 'success');
          } catch (error) {
            showStatus(`‚ùå Payment failed: ${error.message}`, 'error');
          }
        };
      </script>
    </div>
  </body>
</html>